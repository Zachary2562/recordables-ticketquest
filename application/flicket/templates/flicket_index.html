{% extends "flicket_base.html" %}
<!-- extend from base layout -->
{% block content %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" onerror="console.warn('D3.js failed to load')"></script>
    <script src="{{ url_for('flicket_bp.static', filename='js/plotly.min.js') }}" onerror="console.warn('Plotly.js failed to load')"></script>
    <link rel="stylesheet" href="{{ url_for('flicket_bp.static', filename='css/dashboard.css') }}">
    <style>
        /* Always show carousel controls */
        .carousel-control-prev,
        .carousel-control-next {
            display: block !important;
            opacity: 0.95;
            background-color: #ffffff;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            top: 10px;
            transform: none;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex !important;
            align-items: center;
            justify-content: center;
        }
        
        .carousel-control-prev {
            left: 10px;
        }
        
        .carousel-control-next {
            right: 10px;
        }
        
        .carousel-control-prev:hover,
        .carousel-control-next:hover {
            opacity: 1;
            background-color: #f8f9fa;
            border-color: #007bff;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            width: 16px;
            height: 16px;
            filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(190deg) brightness(118%) contrast(119%);
        }
        
        /* Style carousel indicators */
        .carousel-indicators {
            bottom: -30px;
        }
        
        .carousel-indicators li {
            background-color: #007bff;
            border: 1px solid #007bff;
        }
        
        .carousel-indicators li.active {
            background-color: #0056b3;
        }
        
        /* Fix High Priority badge text color */
        .badge-warning {
            color: #fff !important;
        }
        
        /* Position carousel relative to ticket content */
        .carousel {
            position: relative;
            padding: 0 40px;
        }
    </style>

    <div class="container">

        <!-- Welcome Header -->
        <div class="row m-2 p-4 border rounded bg-white">
            <div class="col text-center">
                <h1 class="mb-3">Welcome to Recordables TicketQuest‚Ñ¢</h1>
                <p class="lead text-muted mb-3">How can we help you today?</p>
                
                <!-- Compact Open Tickets Badge (admin only) -->
                {% if g.user.is_admin or g.user.is_super_user %}
                <div class="open-badge mx-auto">
                    <span class="dot" aria-hidden="true"></span>
                    <span>Open Tickets:</span>
                    <span aria-live="polite" aria-atomic="true">{{ open_count }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Cards -->
        <div class="row m-2 justify-content-center">
            <div class="col-md-6 mb-3">
                <div class="dashboard-card h-100">
                    <div class="d-flex flex-column align-items-center text-center">
                        <div style="font-size:40px; line-height:1">üì©</div>
                        <h3 class="mt-2">Create New Ticket</h3>
                        <p class="text-muted">Submit a new support request</p>
                        <a href="{{ url_for('flicket_bp.ticket_create') }}" class="btn btn-primary">Get Started</a>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="dashboard-card h-100">
                    <div class="d-flex flex-column align-items-center text-center">
                        <div style="font-size:40px; line-height:1">üìÅ</div>
                        {% if g.user.is_admin or g.user.is_super_user %}
                        <h3 class="mt-2">All Tickets</h3>
                        <p class="text-muted">View all tickets in the system</p>
                        <a href="{{ url_for('flicket_bp.my_tickets') }}" class="btn btn-success">View All</a>
                        {% else %}
                        <h3 class="mt-2">My Tickets</h3>
                        <p class="text-muted">View all your requests</p>
                        <a href="{{ url_for('flicket_bp.my_tickets') }}" class="btn btn-success">View Tickets</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Priority Tickets Sections (Admin Only) -->
        {% if g.user.is_admin or g.user.is_super_user %}
        {% if urgent_tickets|length > 0 or high_tickets|length > 0 or medium_tickets|length > 0 or low_tickets|length > 0 %}
        
        <!-- Urgent Priority Tickets -->
        {% if urgent_tickets|length > 0 %}
        <div class="row m-2 p-3 border rounded bg-white">
            <div class="col">
                <div class="row">
                    <div class="col text-center">
                        <h2 class="text-danger">Urgent Priority Tickets <span class="badge badge-danger">{{ urgent_tickets|length }}</span></h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="carouselUrgent" class="carousel slide mt-3" data-ride="carousel">
                            <a class="carousel-control-prev" href="#carouselUrgent" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselUrgent" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                            <div class="carousel-inner">
                                {% for t in urgent_tickets %}
                                    <div class="bg-white carousel-item {% if loop.first %} active {% endif %}">
                                        {% include('flicket_items.html') %}
                                    </div>
                                {% endfor %}
                            </div>
                            <ol class="carousel-indicators">
                                {% for t in urgent_tickets %}
                                <li data-target="#carouselUrgent" data-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active"{% endif %}></li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- High Priority Tickets -->
        {% if high_tickets|length > 0 %}
        <div class="row m-2 p-3 border rounded bg-white">
            <div class="col">
                <div class="row">
                    <div class="col text-center">
                        <h2 style="color: #ffc107;">High Priority Tickets <span class="badge badge-warning">{{ high_tickets|length }}</span></h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="carouselHigh" class="carousel slide mt-3" data-ride="carousel">
                            <a class="carousel-control-prev" href="#carouselHigh" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselHigh" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                            <div class="carousel-inner">
                                {% for t in high_tickets %}
                                    <div class="bg-white carousel-item {% if loop.first %} active {% endif %}">
                                        {% include('flicket_items.html') %}
                                    </div>
                                {% endfor %}
                            </div>
                            <ol class="carousel-indicators">
                                {% for t in high_tickets %}
                                <li data-target="#carouselHigh" data-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active"{% endif %}></li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Medium Priority Tickets -->
        {% if medium_tickets|length > 0 %}
        <div class="row m-2 p-3 border rounded bg-white">
            <div class="col">
                <div class="row">
                    <div class="col text-center">
                        <h2 class="text-info">Medium Priority Tickets <span class="badge badge-info">{{ medium_tickets|length }}</span></h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="carouselMedium" class="carousel slide mt-3" data-ride="carousel">
                            <a class="carousel-control-prev" href="#carouselMedium" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselMedium" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                            <div class="carousel-inner">
                                {% for t in medium_tickets %}
                                    <div class="bg-white carousel-item {% if loop.first %} active {% endif %}">
                                        {% include('flicket_items.html') %}
                                    </div>
                                {% endfor %}
                            </div>
                            <ol class="carousel-indicators">
                                {% for t in medium_tickets %}
                                <li data-target="#carouselMedium" data-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active"{% endif %}></li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Low Priority Tickets -->
        {% if low_tickets|length > 0 %}
        <div class="row m-2 p-3 border rounded bg-white">
            <div class="col">
                <div class="row">
                    <div class="col text-center">
                        <h2 class="text-success">Low Priority Tickets <span class="badge badge-success">{{ low_tickets|length }}</span></h2>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <div id="carouselLow" class="carousel slide mt-3" data-ride="carousel">
                            <a class="carousel-control-prev" href="#carouselLow" role="button" data-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carouselLow" role="button" data-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                            </a>
                            <div class="carousel-inner">
                                {% for t in low_tickets %}
                                    <div class="bg-white carousel-item {% if loop.first %} active {% endif %}">
                                        {% include('flicket_items.html') %}
                                    </div>
                                {% endfor %}
                            </div>
                            <ol class="carousel-indicators">
                                {% for t in low_tickets %}
                                <li data-target="#carouselLow" data-slide-to="{{ loop.index0 }}" {% if loop.first %}class="active"{% endif %}></li>
                                {% endfor %}
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% endif %}
        {% endif %}

    </div>

    <script type="text/javascript">
        // Wait for Plotly to be available
        function initPlotly() {
            if (typeof Plotly !== 'undefined' && graphs && ids) {
                try {
                    for (var i in graphs) {
                        if (ids[i] && document.getElementById(ids[i])) {
                            Plotly.plot(ids[i], // the ID of the div, created above
                                graphs[i].data,
                                graphs[i].layout || {},
                                {responsive: true});
                        }
                    }
                } catch (error) {
                    console.warn('Plotly initialization error:', error);
                }
            } else {
                // Retry after a short delay if Plotly isn't loaded yet
                setTimeout(initPlotly, 100);
            }
        }
        
        var graphs = {{graph_json | safe}};
        var ids = {{ids | safe}};
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initPlotly);
        } else {
            initPlotly();
        }
    </script>

{% endblock %}